const { resolve } = require('../../api');
const { visaErrorHandler } = require('../../utils');

module.exports = (RED) => {
  function resolveHandler(config) {
    RED.nodes.createNode(this, config);

    const node = this;

    node.on('input', async (msg) => {
      console.log(msg)
      try {
        const body = {
          alias: RED.util.evaluateNodeProperty(
            config.alias,
            config.aliasType,
            this,
            msg,
          ),
          businessApplicationId: config.businessApplicationId,
          aliasType: config.aliasTypeParam,
          accountLookUp: config.accountLookUp
        };

        const response = await resolve({
          body,
        });
        msg.payload = response.data;
        msg.status = response.status;
        node.send([msg]);
      } catch (error) {
        const { errorCode, message, status } = visaErrorHandler(error);
        msg.status = status;
        msg.error = { errorCode, message };
        if (String(status)[0] === '4'){
          node.send([, msg]);
        } else 
       { node.send([, , msg]);}
      }
    });
  }

  RED.nodes.registerType('Resolve', resolveHandler);
};
